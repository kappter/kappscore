<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameScore Pro - Ultimate Solution</title>
    <style>
        :root {
            --primary-color: #4169e1;
            --secondary-color: #20c997;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary-color: #5379f6;
            --secondary-color: #25e0a8;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #f0f0f0;
            --border-color: #333333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
            padding-bottom: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--card-background);
            padding: 15px 20px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            flex-direction: column;
        }

        .logo h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.8rem;
        }

        .logo p {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-color);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
        }

        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .landing-card {
            text-align: center;
            padding: 40px 20px;
            cursor: pointer;
        }

        .landing-card h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .landing-card p {
            color: var(--text-color);
            opacity: 0.8;
        }

        .landing-card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: block;
        }

        .landing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--card-background);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .player-counter {
            display: flex;
            align-items: center;
        }

        .counter-btn {
            width: 40px;
            height: 40px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: var(--border-radius);
        }

        .counter-input {
            width: 60px;
            text-align: center;
            margin: 0 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input {
            margin-right: 10px;
        }

        .page-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .success-message {
            text-align: center;
            color: var(--success-color);
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .session-code {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 5px;
            margin: 20px 0;
            color: var(--primary-color);
        }

        .session-info {
            background-color: var(--card-background);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .session-info p {
            margin: 5px 0;
        }

        .how-to-join {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        [data-theme="dark"] .how-to-join {
            background-color: #1a3a5f;
        }

        .how-to-join h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .how-to-join ol {
            margin-left: 20px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .scorekeeper-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .scorekeeper-header h2 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .scorekeeper-header p {
            color: var(--text-color);
            opacity: 0.8;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-card {
            position: relative;
            border-left: 5px solid var(--secondary-color);
        }

        .player-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            cursor: pointer;
            display: inline-block;
            border-bottom: 1px dashed transparent;
            transition: var(--transition);
        }

        .player-name:hover {
            border-bottom-color: var(--text-color);
        }

        .player-score {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .score-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .score-btn {
            padding: 10px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
        }

        .score-btn:hover {
            transform: translateY(-2px);
        }

        .score-btn.minus {
            background-color: #ff6b6b;
            color: white;
        }

        .score-btn.plus {
            background-color: #51cf66;
            color: white;
        }

        .score-btn.custom {
            background-color: #f8f9fa;
            color: #333;
        }

        [data-theme="dark"] .score-btn.custom {
            background-color: #2c2c2c;
            color: #f0f0f0;
        }

        .player-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .player-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .badge-host {
            background-color: #ff922b;
        }

        .badge-you {
            background-color: var(--secondary-color);
        }

        .footer-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            max-width: 300px;
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        .toast.info {
            background-color: var(--info-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .back-btn {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            margin-bottom: 20px;
            display: inline-block;
        }

        .back-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .color-option:hover {
            transform: scale(1.2);
        }

        .color-option.selected {
            border: 2px solid white;
            box-shadow: 0 0 0 2px #333;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            transform: translateY(-50px);
            transition: var(--transition);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .team-setup {
            margin-top: 20px;
        }

        .team-list {
            margin-bottom: 20px;
        }

        .team-card {
            margin-bottom: 15px;
            border-left: 5px solid var(--primary-color);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .team-score {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .team-members {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .team-member {
            background-color: var(--background-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .create-team-form {
            margin-top: 20px;
        }

        .player-view-card {
            text-align: center;
        }

        .player-view-score {
            font-size: 5rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .spectator-view {
            text-align: center;
        }

        .spectator-players {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .spectator-player {
            background-color: var(--card-background);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .spectator-player-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .spectator-player-score {
            font-size: 2rem;
            font-weight: bold;
        }

        .custom-score-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--card-background);
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .players-grid {
                grid-template-columns: 1fr;
            }

            .footer-actions {
                grid-template-columns: 1fr;
            }

            .session-code {
                font-size: 2rem;
                letter-spacing: 3px;
            }

            .logo h1 {
                font-size: 1.5rem;
            }

            .header-controls {
                flex-direction: column;
                align-items: flex-end;
            }
        }

        /* Hide pages by default */
        #createSession, #joinSession, #sessionSuccess, #scorekeeper, #playerView, #spectatorView, #teamSetup {
            display: none;
        }

        /* Show landing page by default */
        #landing {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <h1>GameScore Pro</h1>
            <p>Universal score tracking for any game</p>
        </div>
        <div class="header-controls">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span>Local Mode</span>
            </div>
            <a href="#" id="exportBtn" class="btn">📊 Export</a>
            <button id="themeToggle" class="theme-toggle">🌙</button>
        </div>
    </header>

    <div class="container">
        <!-- Landing Page -->
        <div id="landing">
            <div class="landing-grid">
                <div class="card landing-card" id="createSessionCard">
                    <i>🎮</i>
                    <h2>Create New Session</h2>
                    <p>Start a new game and be the scorekeeper</p>
                </div>
                <div class="card landing-card" id="joinSessionCard">
                    <i>👥</i>
                    <h2>Join Session</h2>
                    <p>Enter a code to join an existing game</p>
                </div>
            </div>
        </div>

        <!-- Create Session Page -->
        <div id="createSession">
            <button class="back-btn" id="createBackBtn">← Back</button>
            <h2 class="page-title">Create New Session</h2>
            <div class="card">
                <form id="createSessionForm">
                    <div class="form-group">
                        <label for="sessionName">Session Name (Optional)</label>
                        <input type="text" id="sessionName" class="form-control" placeholder="e.g., Friday Night Cards">
                    </div>
                    <div class="form-group">
                        <label for="playerCount">Number of Players</label>
                        <div class="player-counter">
                            <button type="button" id="decreasePlayerBtn" class="counter-btn">-</button>
                            <input type="number" id="playerCount" class="form-control counter-input" value="2" min="1" max="10">
                            <button type="button" id="increasePlayerBtn" class="counter-btn">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="startingScore">Starting Score</label>
                        <input type="number" id="startingScore" class="form-control" value="0">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowDecimals">
                        <label for="allowDecimals">Allow decimal scores</label>
                    </div>
                    <div class="form-group">
                        <label for="targetScore">Target Score (Optional)</label>
                        <input type="number" id="targetScore" class="form-control" placeholder="e.g., 100">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="playAfterTarget">
                        <label for="playAfterTarget">Continue playing after target score is reached</label>
                    </div>
                    <button type="submit" class="btn btn-primary">🎲 Create Session</button>
                </form>
            </div>
        </div>

        <!-- Join Session Page -->
        <div id="joinSession">
            <button class="back-btn" id="joinBackBtn">← Back</button>
            <h2 class="page-title">Join Session</h2>
            <div class="card">
                <form id="joinSessionForm">
                    <div class="form-group">
                        <label for="sessionCode">Session Code</label>
                        <input type="text" id="sessionCode" class="form-control" placeholder="Enter 6-character code" maxlength="6">
                    </div>
                    <div class="form-group">
                        <label for="playerName">Your Name</label>
                        <input type="text" id="playerName" class="form-control" placeholder="Enter your name">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="joinAsSpectator">
                        <label for="joinAsSpectator">Join as spectator (view only)</label>
                    </div>
                    <button type="submit" class="btn btn-primary">🎮 Join Game</button>
                </form>
            </div>
        </div>

        <!-- Session Success Page -->
        <div id="sessionSuccess">
            <h2 class="success-message">🎉 Session Created Successfully!</h2>
            <div class="card">
                <div class="session-code" id="displaySessionCode">ABC123</div>
                <p class="text-center">Share this code with other players</p>
            </div>
            <div class="session-info">
                <h3>Session Details:</h3>
                <p><strong>Name:</strong> <span id="displaySessionName">Game Session</span></p>
                <p><strong>Players:</strong> <span id="displayPlayerCount">2</span></p>
                <p><strong>Starting Score:</strong> <span id="displayStartingScore">0</span></p>
                <p><strong>Target Score:</strong> <span id="displayTargetScore">None</span></p>
            </div>
            <div class="how-to-join">
                <h3>How to Join:</h3>
                <ol>
                    <li>Other players visit this page</li>
                    <li>Click "Join Session"</li>
                    <li>Enter the session code: <strong id="displaySessionCodeInstructions">ABC123</strong></li>
                    <li>Enter their name</li>
                </ol>
            </div>
            <div class="action-buttons">
                <button id="startScoringBtn" class="btn btn-primary">🎮 Start Scoring</button>
                <button id="copyCodeBtn" class="btn btn-secondary">📋 Copy Code</button>
                <button id="setupTeamsBtn" class="btn">👥 Setup Teams</button>
                <button id="backToHomeBtn" class="btn btn-outline">← Back to Home</button>
            </div>
        </div>

        <!-- Scorekeeper View -->
        <div id="scorekeeper">
            <div class="scorekeeper-header">
                <h2>🎮 Scorekeeper Mode</h2>
                <p>Session: <span id="scorekeeperSessionCode">ABC123</span> | <span id="scorekeeperSessionName">Game Session</span></p>
                <p>Target Score: <span id="scorekeeperTargetScore">None</span> | Managing <span id="scorekeeperPlayerCount">2</span> players</p>
            </div>
            <div id="playersContainer" class="players-grid">
                <!-- Player cards will be generated here -->
            </div>
            <div class="footer-actions">
                <button id="shareCodeBtn" class="btn">📋 Share Code</button>
                <button id="viewReportBtn" class="btn">📊 View Report</button>
                <button id="resetScoresBtn" class="btn">🔄 Reset Scores</button>
                <button id="endGameBtn" class="btn">🚪 End Game</button>
            </div>
        </div>

        <!-- Player View -->
        <div id="playerView">
            <div class="scorekeeper-header">
                <h2>🎮 Player Mode</h2>
                <p>Session: <span id="playerViewSessionCode">ABC123</span> | <span id="playerViewSessionName">Game Session</span></p>
            </div>
            <div class="card player-view-card">
                <h3 id="playerViewName">Your Name</h3>
                <div id="playerViewScore" class="player-view-score">0</div>
                <p>The scorekeeper is updating scores</p>
                <div class="action-buttons">
                    <button id="playerViewBackBtn" class="btn btn-outline">← Back to Home</button>
                </div>
            </div>
        </div>

        <!-- Spectator View -->
        <div id="spectatorView">
            <div class="scorekeeper-header">
                <h2>👁️ Spectator Mode</h2>
                <p>Session: <span id="spectatorSessionCode">ABC123</span> | <span id="spectatorSessionName">Game Session</span></p>
                <p>Target Score: <span id="spectatorTargetScore">None</span></p>
            </div>
            <div id="spectatorPlayersContainer" class="spectator-players">
                <!-- Spectator player cards will be generated here -->
            </div>
            <div class="action-buttons">
                <button id="spectatorBackBtn" class="btn btn-outline">← Back to Home</button>
            </div>
        </div>

        <!-- Team Setup -->
        <div id="teamSetup">
            <div class="scorekeeper-header">
                <h2>👥 Team Setup</h2>
                <p>Session: <span id="teamSetupSessionCode">ABC123</span> | <span id="teamSetupSessionName">Game Session</span></p>
            </div>
            <div class="card">
                <h3>Current Teams</h3>
                <div id="teamList" class="team-list">
                    <!-- Team cards will be generated here -->
                </div>
                <div class="create-team-form">
                    <h3>Create New Team</h3>
                    <form id="createTeamForm">
                        <div class="form-group">
                            <label for="teamName">Team Name</label>
                            <input type="text" id="teamName" class="form-control" placeholder="Enter team name">
                        </div>
                        <button type="submit" class="btn btn-primary">Create Team</button>
                    </form>
                </div>
            </div>
            <div class="action-buttons">
                <button id="teamSetupDoneBtn" class="btn btn-primary">Done</button>
                <button id="teamSetupBackBtn" class="btn btn-outline">← Back</button>
            </div>
        </div>
    </div>

    <!-- Custom Score Modal -->
    <div id="customScoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Enter Custom Score</h3>
                <button class="modal-close" id="closeCustomScoreModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="number" id="customScoreInput" class="custom-score-input" placeholder="Enter score change">
            </div>
            <div class="modal-footer">
                <button id="cancelCustomScore" class="btn btn-outline">Cancel</button>
                <button id="applyCustomScore" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div id="colorPickerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Choose Player Color</h3>
                <button class="modal-close" id="closeColorPickerModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="color-picker" id="colorOptions">
                    <div class="color-option" style="background-color: #20c997;" data-color="#20c997"></div>
                    <div class="color-option" style="background-color: #fd7e14;" data-color="#fd7e14"></div>
                    <div class="color-option" style="background-color: #dc3545;" data-color="#dc3545"></div>
                    <div class="color-option" style="background-color: #6f42c1;" data-color="#6f42c1"></div>
                    <div class="color-option" style="background-color: #0dcaf0;" data-color="#0dcaf0"></div>
                    <div class="color-option" style="background-color: #198754;" data-color="#198754"></div>
                    <div class="color-option" style="background-color: #ffc107;" data-color="#ffc107"></div>
                    <div class="color-option" style="background-color: #0d6efd;" data-color="#0d6efd"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Player Name Modal -->
    <div id="editNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Player Name</h3>
                <button class="modal-close" id="closeEditNameModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="editNameInput" class="form-control" placeholder="Enter new name">
            </div>
            <div class="modal-footer">
                <button id="cancelEditName" class="btn btn-outline">Cancel</button>
                <button id="applyEditName" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <script>
        // GameScore Pro - Ultimate Solution
        console.log("GameScore Pro starting...");

        // Global variables
        let currentSession = null;
        let currentPlayerId = null;
        let currentPlayerName = "Guest";
        let currentPlayerTileColor = '#20c997';
        let selectedPlayerId = null;
        let isDarkTheme = localStorage.getItem('darkTheme') === 'true';

        // Apply theme on load
        if (isDarkTheme) {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').textContent = '☀️';
        }

        // Utility functions
        function generateSessionCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function showPage(pageId) {
            // Hide all pages
            document.getElementById('landing').style.display = 'none';
            document.getElementById('createSession').style.display = 'none';
            document.getElementById('joinSession').style.display = 'none';
            document.getElementById('sessionSuccess').style.display = 'none';
            document.getElementById('scorekeeper').style.display = 'none';
            document.getElementById('playerView').style.display = 'none';
            document.getElementById('spectatorView').style.display = 'none';
            document.getElementById('teamSetup').style.display = 'none';
            
            // Show the requested page
            document.getElementById(pageId).style.display = 'block';
            console.log(`Page shown successfully: ${pageId}`);
        }

        function showMessage(message, type = 'info') {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function saveSessionData(session) {
            // Save to localStorage
            localStorage.setItem(`gameScore_session_${session.code}`, JSON.stringify(session));
            
            // Update URL with session code and data
            const sessionData = encodeURIComponent(btoa(JSON.stringify(session)));
            const url = new URL(window.location.href);
            url.searchParams.set('session', session.code);
            url.searchParams.set('data', sessionData);
            window.history.replaceState({}, '', url.toString());
            
            console.log(`Session ${session.code} saved successfully`);
            return session;
        }

        function loadSessionData(code) {
            // Try to load from URL first
            const urlParams = new URLSearchParams(window.location.search);
            const sessionCode = urlParams.get('session');
            const sessionData = urlParams.get('data');
            
            if (sessionCode === code && sessionData) {
                try {
                    const decodedData = JSON.parse(atob(decodeURIComponent(sessionData)));
                    console.log(`Session ${code} loaded from URL`);
                    return decodedData;
                } catch (e) {
                    console.error('Error decoding session data from URL:', e);
                }
            }
            
            // Try to load from localStorage
            const storedSession = localStorage.getItem(`gameScore_session_${code}`);
            if (storedSession) {
                try {
                    const sessionData = JSON.parse(storedSession);
                    console.log(`Session ${code} loaded from localStorage`);
                    return sessionData;
                } catch (e) {
                    console.error('Error parsing session data from localStorage:', e);
                }
            }
            
            console.log(`Session ${code} not found`);
            return null;
        }

        function getAllSessions() {
            const sessions = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('gameScore_session_')) {
                    try {
                        const sessionData = JSON.parse(localStorage.getItem(key));
                        sessions.push(sessionData);
                    } catch (e) {
                        console.error('Error parsing session data:', e);
                    }
                }
            }
            return sessions;
        }

        function updateScorekeeperInterface() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Update header information
            document.getElementById('scorekeeperSessionCode').textContent = currentSession.code;
            document.getElementById('scorekeeperSessionName').textContent = currentSession.name || 'Unnamed Session';
            document.getElementById('scorekeeperTargetScore').textContent = currentSession.targetScore || 'None';
            document.getElementById('scorekeeperPlayerCount').textContent = currentSession.players.length;
            
            // Clear existing player cards
            const playersContainer = document.getElementById('playersContainer');
            playersContainer.innerHTML = '';
            
            // Generate player cards
            currentSession.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'card player-card';
                playerCard.style.borderLeftColor = player.color || '#20c997';
                
                // Add badges if applicable
                let badgesHTML = '';
                if (player.isHost) {
                    badgesHTML += '<span class="player-badge badge-host">Host</span>';
                }
                if (player.id === currentPlayerId) {
                    badgesHTML += '<span class="player-badge badge-you">You</span>';
                }
                
                // Create player card HTML
                playerCard.innerHTML = `
                    ${badgesHTML}
                    <div class="player-name" data-player-id="${player.id}">${player.name}</div>
                    <div class="player-score">${player.score}</div>
                    <div class="score-buttons">
                        <button class="score-btn minus" data-player-id="${player.id}" data-value="-10">-10</button>
                        <button class="score-btn minus" data-player-id="${player.id}" data-value="-5">-5</button>
                        <button class="score-btn minus" data-player-id="${player.id}" data-value="-1">-1</button>
                        <button class="score-btn custom" data-player-id="${player.id}" data-value="custom">1</button>
                        <button class="score-btn plus" data-player-id="${player.id}" data-value="+1">+1</button>
                        <button class="score-btn plus" data-player-id="${player.id}" data-value="+5">+5</button>
                        <button class="score-btn plus" data-player-id="${player.id}" data-value="+10">+10</button>
                    </div>
                    <div class="player-actions">
                        <button class="btn btn-outline" data-player-id="${player.id}" data-action="reset">🔄 Reset</button>
                        <button class="btn btn-outline" data-player-id="${player.id}" data-action="color">🎨 Color</button>
                    </div>
                `;
                
                playersContainer.appendChild(playerCard);
            });
            
            // Add event listeners to player cards
            addPlayerCardEventListeners();
        }

        function updatePlayerView() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find current player
            const player = currentSession.players.find(p => p.id === currentPlayerId);
            if (!player) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Update player view
            document.getElementById('playerViewSessionCode').textContent = currentSession.code;
            document.getElementById('playerViewSessionName').textContent = currentSession.name || 'Unnamed Session';
            document.getElementById('playerViewName').textContent = player.name;
            document.getElementById('playerViewScore').textContent = player.score;
        }

        function updateSpectatorView() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Update header information
            document.getElementById('spectatorSessionCode').textContent = currentSession.code;
            document.getElementById('spectatorSessionName').textContent = currentSession.name || 'Unnamed Session';
            document.getElementById('spectatorTargetScore').textContent = currentSession.targetScore || 'None';
            
            // Clear existing player cards
            const spectatorPlayersContainer = document.getElementById('spectatorPlayersContainer');
            spectatorPlayersContainer.innerHTML = '';
            
            // Generate player cards
            currentSession.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'spectator-player';
                playerCard.style.borderLeft = `5px solid ${player.color || '#20c997'}`;
                
                // Add badges if applicable
                let badgesHTML = '';
                if (player.isHost) {
                    badgesHTML += ' (Host)';
                }
                
                // Create player card HTML
                playerCard.innerHTML = `
                    <div class="spectator-player-name">${player.name}${badgesHTML}</div>
                    <div class="spectator-player-score">${player.score}</div>
                `;
                
                spectatorPlayersContainer.appendChild(playerCard);
            });
        }

        function updateTeamSetupInterface() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Update header information
            document.getElementById('teamSetupSessionCode').textContent = currentSession.code;
            document.getElementById('teamSetupSessionName').textContent = currentSession.name || 'Unnamed Session';
            
            // Clear existing team cards
            const teamList = document.getElementById('teamList');
            teamList.innerHTML = '';
            
            // Generate team cards
            if (currentSession.teams && Object.keys(currentSession.teams).length > 0) {
                Object.entries(currentSession.teams).forEach(([teamId, team]) => {
                    const teamCard = document.createElement('div');
                    teamCard.className = 'card team-card';
                    teamCard.style.borderLeftColor = team.color || '#4169e1';
                    
                    // Calculate team score
                    const teamScore = calculateTeamScore(teamId);
                    
                    // Get team members
                    const teamMembers = currentSession.players.filter(player => 
                        player.teamId === teamId
                    );
                    
                    let membersHTML = '';
                    if (teamMembers.length > 0) {
                        membersHTML = '<div class="team-members">';
                        teamMembers.forEach(player => {
                            membersHTML += `<div class="team-member">${player.name}</div>`;
                        });
                        membersHTML += '</div>';
                    } else {
                        membersHTML = '<p>No members yet</p>';
                    }
                    
                    // Create team card HTML
                    teamCard.innerHTML = `
                        <div class="team-header">
                            <div class="team-name">${team.name}</div>
                            <div class="team-score">${teamScore}</div>
                            <button class="btn btn-outline" data-team-id="${teamId}" data-action="delete">🗑️</button>
                        </div>
                        ${membersHTML}
                    `;
                    
                    teamList.appendChild(teamCard);
                });
            } else {
                teamList.innerHTML = '<p>No teams created yet</p>';
            }
            
            // Add event listeners to team cards
            addTeamCardEventListeners();
        }

        function calculateTeamScore(teamId) {
            if (!currentSession || !currentSession.teams || !currentSession.teams[teamId]) {
                return 0;
            }
            
            // Sum up scores of all players in the team
            return currentSession.players
                .filter(player => player.teamId === teamId)
                .reduce((sum, player) => sum + player.score, 0);
        }

        function updateScore(playerId, change) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            const player = currentSession.players[playerIndex];
            const oldScore = player.score;
            const newScore = currentSession.allowDecimals ? 
                parseFloat((oldScore + change).toFixed(2)) : 
                Math.round(oldScore + change);
            
            // Update player score
            player.score = newScore;
            
            // Add to player history
            if (!player.history) {
                player.history = [];
            }
            
            player.history.push({
                score: newScore,
                change: change,
                timestamp: Date.now()
            });
            
            // Add to session history
            if (!currentSession.history) {
                currentSession.history = [];
            }
            
            currentSession.history.push({
                playerId: playerId,
                playerName: player.name,
                oldScore: oldScore,
                newScore: newScore,
                change: change,
                timestamp: Date.now()
            });
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateScorekeeperInterface();
            
            console.log(`Player ${player.name} score changed by ${change} to ${newScore}`);
            return newScore;
        }

        function resetPlayerScore(playerId) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            const player = currentSession.players[playerIndex];
            const oldScore = player.score;
            
            // Reset to starting score
            player.score = currentSession.startingScore || 0;
            
            // Add to player history
            if (!player.history) {
                player.history = [];
            }
            
            player.history.push({
                score: player.score,
                change: player.score - oldScore,
                timestamp: Date.now()
            });
            
            // Add to session history
            if (!currentSession.history) {
                currentSession.history = [];
            }
            
            currentSession.history.push({
                playerId: playerId,
                playerName: player.name,
                oldScore: oldScore,
                newScore: player.score,
                change: player.score - oldScore,
                timestamp: Date.now(),
                action: 'reset'
            });
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateScorekeeperInterface();
            
            showMessage(`${player.name}'s score has been reset`, 'info');
        }

        function resetAllScores() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Reset all player scores
            currentSession.players.forEach(player => {
                const oldScore = player.score;
                player.score = currentSession.startingScore || 0;
                
                // Add to player history
                if (!player.history) {
                    player.history = [];
                }
                
                player.history.push({
                    score: player.score,
                    change: player.score - oldScore,
                    timestamp: Date.now()
                });
            });
            
            // Add to session history
            if (!currentSession.history) {
                currentSession.history = [];
            }
            
            currentSession.history.push({
                action: 'reset_all',
                timestamp: Date.now()
            });
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateScorekeeperInterface();
            
            showMessage('All scores have been reset', 'info');
        }

        function updatePlayerColor(playerId, color) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Update player color
            currentSession.players[playerIndex].color = color;
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateScorekeeperInterface();
            
            showMessage('Player color updated', 'success');
        }

        function editPlayerName(playerId, newName) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Check permissions
            const currentPlayer = currentSession.players.find(p => p.id === currentPlayerId);
            if (!currentPlayer.isHost && currentPlayerId !== playerId) {
                showMessage('You can only edit your own name', 'error');
                return;
            }
            
            // Update player name
            const oldName = currentSession.players[playerIndex].name;
            currentSession.players[playerIndex].name = newName;
            
            // Add to session history
            if (!currentSession.history) {
                currentSession.history = [];
            }
            
            currentSession.history.push({
                playerId: playerId,
                oldName: oldName,
                newName: newName,
                timestamp: Date.now(),
                action: 'rename'
            });
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateScorekeeperInterface();
            
            showMessage('Player name updated', 'success');
        }

        function createTeam(teamName) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Initialize teams object if it doesn't exist
            if (!currentSession.teams) {
                currentSession.teams = {};
            }
            
            // Generate team ID
            const teamId = 'team_' + Date.now();
            
            // Create team
            currentSession.teams[teamId] = {
                id: teamId,
                name: teamName,
                color: getRandomColor(),
                createdAt: Date.now()
            };
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateTeamSetupInterface();
            
            showMessage('Team created successfully', 'success');
            return teamId;
        }

        function deleteTeam(teamId) {
            if (!currentSession || !currentSession.teams || !currentSession.teams[teamId]) {
                showMessage('Team not found', 'error');
                return;
            }
            
            // Remove team ID from all players in this team
            currentSession.players.forEach(player => {
                if (player.teamId === teamId) {
                    delete player.teamId;
                }
            });
            
            // Delete team
            delete currentSession.teams[teamId];
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateTeamSetupInterface();
            
            showMessage('Team deleted', 'success');
        }

        function assignPlayerToTeam(playerId, teamId) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Check if team exists
            if (teamId && (!currentSession.teams || !currentSession.teams[teamId])) {
                showMessage('Team not found', 'error');
                return;
            }
            
            // Update player's team
            if (teamId) {
                currentSession.players[playerIndex].teamId = teamId;
            } else {
                delete currentSession.players[playerIndex].teamId;
            }
            
            // Save updated session
            saveSessionData(currentSession);
            
            // Update interfaces
            updateTeamSetupInterface();
            
            showMessage('Player team updated', 'success');
        }

        function exportSessionData() {
            if (!currentSession) {
                showMessage('No active session to export', 'error');
                return;
            }
            
            // Create a copy of the session data
            const exportData = JSON.parse(JSON.stringify(currentSession));
            
            // Add export metadata
            exportData.exportedAt = Date.now();
            
            // Convert to JSON string
            const jsonString = JSON.stringify(exportData, null, 2);
            
            // Create blob and download link
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `gamescore_${currentSession.code}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showMessage('Session data exported successfully', 'success');
        }

        function getRandomColor() {
            const colors = [
                '#20c997', '#fd7e14', '#dc3545', '#6f42c1', 
                '#0dcaf0', '#198754', '#ffc107', '#0d6efd'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function copyToClipboard(text) {
            // Create temporary input element
            const input = document.createElement('input');
            input.value = text;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
        }

        function getSessionFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionCode = urlParams.get('session');
            const sessionData = urlParams.get('data');
            
            if (sessionCode && sessionData) {
                try {
                    const decodedData = JSON.parse(atob(decodeURIComponent(sessionData)));
                    return decodedData;
                } catch (e) {
                    console.error('Error decoding session data from URL:', e);
                }
            } else if (sessionCode) {
                // Try to load from localStorage
                return loadSessionData(sessionCode);
            }
            
            return null;
        }

        // Event listeners for player cards
        function addPlayerCardEventListeners() {
            // Score buttons
            document.querySelectorAll('.score-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const playerId = this.getAttribute('data-player-id');
                    const value = this.getAttribute('data-value');
                    
                    if (value === 'custom') {
                        // Show custom score modal
                        selectedPlayerId = playerId;
                        document.getElementById('customScoreInput').value = '';
                        document.getElementById('customScoreModal').classList.add('active');
                    } else {
                        // Update score directly
                        updateScore(playerId, parseFloat(value));
                    }
                });
            });
            
            // Player actions
            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', function() {
                    const playerId = this.getAttribute('data-player-id');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'reset') {
                        resetPlayerScore(playerId);
                    } else if (action === 'color') {
                        // Show color picker modal
                        selectedPlayerId = playerId;
                        document.getElementById('colorPickerModal').classList.add('active');
                    }
                });
            });
            
            // Player names (for editing)
            document.querySelectorAll('.player-name').forEach(nameElement => {
                nameElement.addEventListener('click', function() {
                    const playerId = this.getAttribute('data-player-id');
                    const player = currentSession.players.find(p => p.id === playerId);
                    
                    // Check permissions
                    const currentPlayer = currentSession.players.find(p => p.id === currentPlayerId);
                    if (!currentPlayer.isHost && currentPlayerId !== playerId) {
                        showMessage('You can only edit your own name', 'error');
                        return;
                    }
                    
                    // Show edit name modal
                    selectedPlayerId = playerId;
                    document.getElementById('editNameInput').value = player.name;
                    document.getElementById('editNameModal').classList.add('active');
                });
            });
        }

        // Event listeners for team cards
        function addTeamCardEventListeners() {
            document.querySelectorAll('[data-team-id][data-action="delete"]').forEach(button => {
                button.addEventListener('click', function() {
                    const teamId = this.getAttribute('data-team-id');
                    deleteTeam(teamId);
                });
            });
        }

        // Initialize the application
        function initApp() {
            console.log("Page loaded, initializing...");
            
            // Check for session in URL
            const urlSession = getSessionFromURL();
            if (urlSession) {
                currentSession = urlSession;
                
                // Determine if user is host, player, or spectator
                if (currentSession.players && currentSession.players.length > 0) {
                    // For now, assume first player is host in URL sessions
                    currentPlayerId = currentSession.players[0].id;
                    currentPlayerName = currentSession.players[0].name;
                    showPage('scorekeeper');
                    updateScorekeeperInterface();
                }
            }
            
            // Button bindings
            console.log("Starting button binding...");
            
            // Create Session button
            const createSessionCard = document.getElementById('createSessionCard');
            console.log("Create button element:", createSessionCard);
            if (createSessionCard) {
                createSessionCard.addEventListener('click', function() {
                    console.log("Create button clicked, navigating to createSession");
                    showPage('createSession');
                });
                console.log("Create button bound");
            }
            
            // Join Session button
            document.getElementById('joinSessionCard').addEventListener('click', function() {
                showPage('joinSession');
                
                // Auto-fill session code from URL if available
                const urlParams = new URLSearchParams(window.location.search);
                const sessionCode = urlParams.get('session');
                if (sessionCode) {
                    document.getElementById('sessionCode').value = sessionCode;
                }
            });
            console.log("Join button bound");
            
            // Create Session form
            document.getElementById('createSessionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form values
                const sessionName = document.getElementById('sessionName').value;
                const playerCount = parseInt(document.getElementById('playerCount').value) || 2;
                const startingScore = parseFloat(document.getElementById('startingScore').value) || 0;
                const allowDecimals = document.getElementById('allowDecimals').checked;
                const targetScore = document.getElementById('targetScore').value ? parseFloat(document.getElementById('targetScore').value) : null;
                const playAfterTarget = document.getElementById('playAfterTarget').checked;
                
                // Generate session code
                const sessionCode = generateSessionCode();
                console.log("Creating session...");
                console.log("Generated session code:", sessionCode);
                
                // Create player list (host only for now)
                const playerId = 'player_' + Date.now();
                currentPlayerId = playerId;
                currentPlayerName = 'Host';
                
                const players = [{
                    id: playerId,
                    name: 'Host',
                    score: startingScore,
                    color: '#20c997',
                    isHost: true,
                    history: [{
                        score: startingScore,
                        change: 0,
                        timestamp: Date.now()
                    }]
                }];
                
                // Create session object
                currentSession = {
                    code: sessionCode,
                    name: sessionName,
                    playerCount: playerCount,
                    startingScore: startingScore,
                    allowDecimals: allowDecimals,
                    targetScore: targetScore,
                    playAfterTarget: playAfterTarget,
                    createdAt: Date.now(),
                    players: players,
                    teams: {},
                    history: []
                };
                
                // Save session data
                saveSessionData(currentSession);
                
                // Update success page
                document.getElementById('displaySessionCode').textContent = sessionCode;
                document.getElementById('displaySessionCodeInstructions').textContent = sessionCode;
                document.getElementById('displaySessionName').textContent = sessionName || 'Unnamed Session';
                document.getElementById('displayPlayerCount').textContent = playerCount;
                document.getElementById('displayStartingScore').textContent = startingScore;
                document.getElementById('displayTargetScore').textContent = targetScore || 'None';
                
                // Show success page
                showPage('sessionSuccess');
            });
            console.log("Create form bound");
            
            // Join Session form
            document.getElementById('joinSessionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form values
                const sessionCode = document.getElementById('sessionCode').value.toUpperCase();
                const playerName = document.getElementById('playerName').value || 'Player';
                const joinAsSpectator = document.getElementById('joinAsSpectator').checked;
                
                console.log(`Attempting to join session ${sessionCode} as ${playerName}`);
                
                // Load session data
                const session = loadSessionData(sessionCode);
                
                if (!session) {
                    // Check if any sessions exist on this device
                    const allSessions = getAllSessions();
                    let errorMessage = `Session "${sessionCode}" not found.`;
                    
                    if (allSessions.length > 0) {
                        errorMessage += ` Available sessions on this device: ${allSessions.map(s => s.code).join(', ')}`;
                    } else {
                        errorMessage += ' No sessions found on this device. Make sure you\'re using the same browser/device where the session was created, or ask the host to share the session URL.';
                    }
                    
                    showMessage(errorMessage, 'error');
                    return;
                }
                
                // Set current session
                currentSession = session;
                
                if (joinAsSpectator) {
                    // Join as spectator (no player creation)
                    currentPlayerName = playerName;
                    showMessage(`Joined as spectator: ${playerName}`, 'success');
                    showPage('spectatorView');
                    updateSpectatorView();
                } else {
                    // Create new player
                    const playerId = 'player_' + Date.now();
                    currentPlayerId = playerId;
                    currentPlayerName = playerName;
                    
                    // Add player to session
                    currentSession.players.push({
                        id: playerId,
                        name: playerName,
                        score: currentSession.startingScore || 0,
                        color: getRandomColor(),
                        isHost: false,
                        history: [{
                            score: currentSession.startingScore || 0,
                            change: 0,
                            timestamp: Date.now()
                        }]
                    });
                    
                    // Save updated session
                    saveSessionData(currentSession);
                    
                    showMessage(`Joined as player: ${playerName}`, 'success');
                    showPage('playerView');
                    updatePlayerView();
                }
            });
            console.log("Join form bound");
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', function() {
                isDarkTheme = !isDarkTheme;
                localStorage.setItem('darkTheme', isDarkTheme);
                
                if (isDarkTheme) {
                    document.body.setAttribute('data-theme', 'dark');
                    this.textContent = '☀️';
                } else {
                    document.body.removeAttribute('data-theme');
                    this.textContent = '🌙';
                }
            });
            console.log("Theme toggle bound");
            
            // Back buttons
            document.getElementById('createBackBtn').addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('joinBackBtn').addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('backToHomeBtn').addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('playerViewBackBtn').addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('spectatorBackBtn').addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('teamSetupBackBtn').addEventListener('click', function() {
                showPage('sessionSuccess');
            });
            
            document.getElementById('teamSetupDoneBtn').addEventListener('click', function() {
                showPage('sessionSuccess');
            });
            
            // Start Scoring button
            document.getElementById('startScoringBtn').addEventListener('click', function() {
                console.log("Start scoring button clicked");
                console.log("Current session:", currentSession);
                console.log("updateScorekeeperInterface function:", updateScorekeeperInterface);
                showPage('scorekeeper');
                updateScorekeeperInterface();
            });
            
            // Copy Code button
            document.getElementById('copyCodeBtn').addEventListener('click', function() {
                // Create shareable URL with session data
                const sessionData = encodeURIComponent(btoa(JSON.stringify(currentSession)));
                const url = new URL(window.location.href);
                url.searchParams.set('session', currentSession.code);
                url.searchParams.set('data', sessionData);
                
                copyToClipboard(url.toString());
                showMessage('Session URL copied to clipboard!', 'success');
            });
            
            // Setup Teams button
            document.getElementById('setupTeamsBtn').addEventListener('click', function() {
                showPage('teamSetup');
                updateTeamSetupInterface();
            });
            
            // Share Code button
            document.getElementById('shareCodeBtn').addEventListener('click', function() {
                // Create shareable URL with session data
                const sessionData = encodeURIComponent(btoa(JSON.stringify(currentSession)));
                const url = new URL(window.location.href);
                url.searchParams.set('session', currentSession.code);
                url.searchParams.set('data', sessionData);
                
                copyToClipboard(url.toString());
                showMessage('Session URL copied to clipboard!', 'success');
            });
            
            // View Report button
            document.getElementById('viewReportBtn').addEventListener('click', function() {
                // For now, just show a message
                showMessage('Report feature coming soon!', 'info');
            });
            
            // Reset Scores button
            document.getElementById('resetScoresBtn').addEventListener('click', function() {
                resetAllScores();
            });
            
            // End Game button
            document.getElementById('endGameBtn').addEventListener('click', function() {
                showPage('landing');
                showMessage('Game ended', 'info');
            });
            
            // Create Team form
            document.getElementById('createTeamForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const teamName = document.getElementById('teamName').value;
                if (!teamName) {
                    showMessage('Please enter a team name', 'error');
                    return;
                }
                
                createTeam(teamName);
                document.getElementById('teamName').value = '';
            });
            
            // Custom Score Modal
            document.getElementById('closeCustomScoreModal').addEventListener('click', function() {
                document.getElementById('customScoreModal').classList.remove('active');
            });
            
            document.getElementById('cancelCustomScore').addEventListener('click', function() {
                document.getElementById('customScoreModal').classList.remove('active');
            });
            
            document.getElementById('applyCustomScore').addEventListener('click', function() {
                const customScore = parseFloat(document.getElementById('customScoreInput').value);
                if (isNaN(customScore)) {
                    showMessage('Please enter a valid number', 'error');
                    return;
                }
                
                updateScore(selectedPlayerId, customScore);
                document.getElementById('customScoreModal').classList.remove('active');
            });
            
            // Color Picker Modal
            document.getElementById('closeColorPickerModal').addEventListener('click', function() {
                document.getElementById('colorPickerModal').classList.remove('active');
            });
            
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    updatePlayerColor(selectedPlayerId, color);
                    document.getElementById('colorPickerModal').classList.remove('active');
                });
            });
            
            // Edit Name Modal
            document.getElementById('closeEditNameModal').addEventListener('click', function() {
                document.getElementById('editNameModal').classList.remove('active');
            });
            
            document.getElementById('cancelEditName').addEventListener('click', function() {
                document.getElementById('editNameModal').classList.remove('active');
            });
            
            document.getElementById('applyEditName').addEventListener('click', function() {
                const newName = document.getElementById('editNameInput').value;
                if (!newName) {
                    showMessage('Please enter a name', 'error');
                    return;
                }
                
                editPlayerName(selectedPlayerId, newName);
                document.getElementById('editNameModal').classList.remove('active');
            });
            
            // Player Count buttons
            document.getElementById('decreasePlayerBtn').addEventListener('click', function() {
                const playerCountInput = document.getElementById('playerCount');
                let count = parseInt(playerCountInput.value) || 2;
                count = Math.max(1, count - 1);
                playerCountInput.value = count;
            });
            console.log("Decrease player button bound");
            
            document.getElementById('increasePlayerBtn').addEventListener('click', function() {
                const playerCountInput = document.getElementById('playerCount');
                let count = parseInt(playerCountInput.value) || 2;
                count = Math.min(10, count + 1);
                playerCountInput.value = count;
            });
            console.log("Increase player button bound");
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', function() {
                if (!currentSession) {
                    showMessage('No active session to export', 'info');
                    return;
                }
                exportSessionData();
            });
            
            console.log("App initialized successfully!");
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
        
        console.log("GameScore Pro script loaded successfully!");
    </script>
</body>
</html>

