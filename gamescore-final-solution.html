<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameScore Pro - Final Solution</title>
    <style>
        :root {
            --primary-color: #4169e1;
            --secondary-color: #20c997;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #28a745;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --light-card: #ffffff;
            --dark-card: #2c3034;
            --light-text: #212529;
            --dark-text: #f8f9fa;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: var(--transition);
        }

        body.dark-theme {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .header {
            background-color: var(--light-card);
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        body.dark-theme .header {
            background-color: var(--dark-card);
        }

        .app-title {
            margin: 0;
            color: var(--primary-color);
            font-size: 28px;
            font-weight: bold;
        }

        .app-subtitle {
            margin: 5px 0 0;
            font-size: 14px;
            color: #6c757d;
        }

        body.dark-theme .app-subtitle {
            color: #adb5bd;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-right: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.online {
            background-color: var(--success-color);
        }

        .status-dot.offline {
            background-color: var(--danger-color);
        }

        .status-dot.local {
            background-color: var(--warning-color);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3151b5;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-light {
            background-color: #f8f9fa;
            color: #212529;
            border: 1px solid #dee2e6;
        }

        .btn-light:hover {
            background-color: #e2e6ea;
        }

        body.dark-theme .btn-light {
            background-color: #495057;
            color: #f8f9fa;
            border: 1px solid #6c757d;
        }

        body.dark-theme .btn-light:hover {
            background-color: #5a6268;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--light-text);
            transition: var(--transition);
        }

        body.dark-theme .theme-toggle {
            color: var(--dark-text);
        }

        .card {
            background-color: var(--light-card);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        body.dark-theme .card {
            background-color: var(--dark-card);
        }

        .landing-card {
            text-align: center;
            padding: 40px 20px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .landing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .landing-card h2 {
            color: var(--primary-color);
            margin-top: 10px;
        }

        .landing-card p {
            color: #6c757d;
            margin-bottom: 0;
        }

        body.dark-theme .landing-card p {
            color: #adb5bd;
        }

        .landing-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light-text);
        }

        body.dark-theme .form-label {
            color: var(--dark-text);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(65, 105, 225, 0.25);
        }

        body.dark-theme .form-control {
            background-color: #495057;
            border-color: #6c757d;
            color: #f8f9fa;
        }

        body.dark-theme .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(65, 105, 225, 0.5);
        }

        .player-counter {
            display: flex;
            align-items: center;
        }

        .counter-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .counter-btn:hover {
            background-color: #3151b5;
        }

        .counter-input {
            width: 60px;
            text-align: center;
            margin: 0 10px;
            font-size: 18px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .session-code {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            color: var(--primary-color);
            letter-spacing: 5px;
        }

        .session-info {
            margin-bottom: 10px;
        }

        .session-info strong {
            font-weight: 600;
            margin-right: 5px;
        }

        .join-steps {
            background-color: #e9f0ff;
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-top: 20px;
        }

        body.dark-theme .join-steps {
            background-color: #2c3e50;
        }

        .join-steps h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .join-steps ol {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .join-steps li {
            margin-bottom: 8px;
        }

        .join-steps li:last-child {
            margin-bottom: 0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .scorekeeper-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .scorekeeper-header h2 {
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .scorekeeper-header p {
            margin: 0;
            color: #6c757d;
        }

        body.dark-theme .scorekeeper-header p {
            color: #adb5bd;
        }

        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-card {
            background-color: var(--light-card);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-top: 5px solid var(--secondary-color);
            transition: var(--transition);
            position: relative;
        }

        body.dark-theme .player-card {
            background-color: var(--dark-card);
        }

        .player-name {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 15px;
            color: var(--light-text);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: #adb5bd;
        }

        body.dark-theme .player-name {
            color: var(--dark-text);
            text-decoration-color: #6c757d;
        }

        .player-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: var(--light-text);
        }

        body.dark-theme .player-score {
            color: var(--dark-text);
        }

        .score-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .score-btn {
            padding: 10px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            text-align: center;
        }

        .score-btn.minus {
            background-color: var(--danger-color);
            color: white;
        }

        .score-btn.minus:hover {
            background-color: #c82333;
        }

        .score-btn.plus {
            background-color: var(--success-color);
            color: white;
        }

        .score-btn.plus:hover {
            background-color: #218838;
        }

        .score-btn.custom {
            background-color: #f8f9fa;
            color: #212529;
        }

        .score-btn.custom:hover {
            background-color: #e2e6ea;
        }

        body.dark-theme .score-btn.custom {
            background-color: #495057;
            color: #f8f9fa;
        }

        body.dark-theme .score-btn.custom:hover {
            background-color: #5a6268;
        }

        .player-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .player-actions button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }

        .player-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .host-badge {
            background-color: var(--primary-color);
            color: white;
        }

        .you-badge {
            background-color: var(--success-color);
            color: white;
        }

        .footer-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease forwards;
            max-width: 350px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background-color: var(--success-color);
            color: white;
        }

        .toast.error {
            background-color: var(--danger-color);
            color: white;
        }

        .toast.info {
            background-color: var(--primary-color);
            color: white;
        }

        .toast.warning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .toast-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
        }

        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .color-option:hover, .color-option.selected {
            transform: scale(1.1);
            border-color: #ffffff;
            box-shadow: 0 0 0 2px #000000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--light-card);
            border-radius: var(--border-radius);
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
        }

        body.dark-theme .modal-content {
            background-color: var(--dark-card);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            margin: 0;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .team-setup {
            margin-top: 20px;
        }

        .team-list {
            margin-bottom: 20px;
        }

        .team-card {
            background-color: var(--light-card);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--box-shadow);
            border-left: 5px solid var(--primary-color);
        }

        body.dark-theme .team-card {
            background-color: var(--dark-card);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team-name {
            margin: 0;
            font-weight: 600;
            color: var(--light-text);
        }

        body.dark-theme .team-name {
            color: var(--dark-text);
        }

        .team-score {
            font-weight: bold;
            font-size: 20px;
            color: var(--primary-color);
        }

        .team-members {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .team-member {
            background-color: #e9f0ff;
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }

        body.dark-theme .team-member {
            background-color: #2c3e50;
        }

        .unassigned-players {
            margin-top: 20px;
        }

        .player-item {
            background-color: var(--light-card);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
        }

        body.dark-theme .player-item {
            background-color: var(--dark-card);
        }

        .player-item-name {
            font-weight: 500;
            color: var(--light-text);
        }

        body.dark-theme .player-item-name {
            color: var(--dark-text);
        }

        .team-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .custom-score-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        body.dark-theme .custom-score-input {
            background-color: #495057;
            border-color: #6c757d;
            color: #f8f9fa;
        }

        @media (max-width: 768px) {
            .player-grid {
                grid-template-columns: 1fr;
            }

            .footer-actions {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-controls {
                margin-top: 15px;
            }

            .session-code {
                font-size: 36px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        /* Transitions for page changes */
        .page {
            display: none;
            animation: fadeIn 0.3s ease forwards;
        }

        .page.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 class="app-title">GameScore Pro</h1>
                <p class="app-subtitle">Universal score tracking for any game</p>
            </div>
            <div class="header-controls">
                <div class="status-indicator">
                    <span class="status-dot local"></span>
                    <span>Local Mode</span>
                </div>
                <a href="#" class="btn btn-light" id="exportBtn">📊 Export</a>
                <button class="theme-toggle" id="themeToggle">🌙</button>
            </div>
        </div>

        <!-- Landing Page -->
        <div id="landing" class="page active">
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="card landing-card" id="createSessionCard" style="flex: 1; min-width: 300px;">
                    <div class="landing-icon">🎮</div>
                    <h2>Create New Session</h2>
                    <p>Start a new game and be the scorekeeper</p>
                </div>
                <div class="card landing-card" id="joinSessionCard" style="flex: 1; min-width: 300px;">
                    <div class="landing-icon">👥</div>
                    <h2>Join Session</h2>
                    <p>Enter a code to join an existing game</p>
                </div>
            </div>
        </div>

        <!-- Create Session Page -->
        <div id="createSession" class="page">
            <button class="btn btn-light" id="backToLandingBtn" style="margin-bottom: 20px;">← Back</button>
            <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">Create New Session</h2>
            <div class="card">
                <form id="createSessionForm">
                    <div class="form-group">
                        <label class="form-label">Session Name (Optional)</label>
                        <input type="text" class="form-control" id="sessionName" placeholder="e.g., Friday Night Cards">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Number of Players</label>
                        <div class="player-counter">
                            <button type="button" class="counter-btn" id="decreasePlayerBtn">-</button>
                            <input type="text" class="form-control counter-input" id="playerCount" value="2" readonly>
                            <button type="button" class="counter-btn" id="increasePlayerBtn">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Starting Score</label>
                        <input type="number" class="form-control" id="startingScore" value="0">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowDecimals">
                        <label for="allowDecimals">Allow decimal scores</label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Score (Optional)</label>
                        <input type="number" class="form-control" id="targetScore" placeholder="e.g., 100">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="playAfterTarget">
                        <label for="playAfterTarget">Continue playing after target score is reached</label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">🎲 Create Session</button>
                </form>
            </div>
        </div>

        <!-- Join Session Page -->
        <div id="joinSession" class="page">
            <button class="btn btn-light" id="backToLandingFromJoinBtn" style="margin-bottom: 20px;">← Back</button>
            <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">Join Session</h2>
            <div class="card">
                <form id="joinSessionForm">
                    <div class="form-group">
                        <label class="form-label">Session Code</label>
                        <input type="text" class="form-control" id="sessionCode" placeholder="Enter 6-character code" maxlength="6" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="playerName" placeholder="Enter your name">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="joinAsSpectator">
                        <label for="joinAsSpectator">Join as spectator (view only)</label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">👥 Join Game</button>
                </form>
            </div>
        </div>

        <!-- Session Success Page -->
        <div id="sessionSuccess" class="page">
            <h2 style="text-align: center; color: var(--success-color); margin-bottom: 20px;">
                🎉 Session Created Successfully!
            </h2>
            <div class="card" style="background-color: var(--primary-color); color: white;">
                <div class="session-code" id="displaySessionCode"></div>
                <p style="text-align: center; margin-bottom: 0;">Share this code with other players</p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">Session Details:</h3>
                <div class="session-info">
                    <strong>Name:</strong> <span id="displaySessionName"></span>
                </div>
                <div class="session-info">
                    <strong>Players:</strong> <span id="displayPlayerCount"></span>
                </div>
                <div class="session-info">
                    <strong>Starting Score:</strong> <span id="displayStartingScore"></span>
                </div>
                <div class="session-info">
                    <strong>Target Score:</strong> <span id="displayTargetScore"></span>
                </div>
            </div>

            <div class="join-steps">
                <h3>How to Join:</h3>
                <ol>
                    <li>Other players visit this page</li>
                    <li>Click "Join Session"</li>
                    <li>Enter the session code: <strong id="displaySessionCodeInSteps"></strong></li>
                    <li>Enter their name</li>
                </ol>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" id="startScoringBtn">🎮 Start Scoring</button>
                <button class="btn btn-primary" id="copyCodeBtn">📋 Copy Code</button>
                <button class="btn btn-info" id="setupTeamsBtn">👥 Setup Teams</button>
                <button class="btn btn-light" id="backToHomeBtn">← Back to Home</button>
            </div>
        </div>

        <!-- Scorekeeper Page -->
        <div id="scorekeeper" class="page">
            <div class="scorekeeper-header">
                <h2>🎮 Scorekeeper Mode</h2>
                <p id="sessionInfo"></p>
            </div>

            <div id="playerGrid" class="player-grid">
                <!-- Player cards will be dynamically added here -->
            </div>

            <div class="footer-actions">
                <button class="btn btn-primary" id="shareCodeBtn">📋 Share Code</button>
                <button class="btn btn-info" id="viewReportBtn">📊 View Report</button>
                <button class="btn btn-warning" id="resetScoresBtn">🔄 Reset Scores</button>
                <button class="btn btn-danger" id="endGameBtn">🚪 End Game</button>
            </div>
        </div>

        <!-- Player View Page -->
        <div id="playerView" class="page">
            <div class="scorekeeper-header">
                <h2>👤 Player View</h2>
                <p id="playerViewSessionInfo"></p>
            </div>

            <div class="card">
                <h3 id="playerViewName" style="margin-top: 0;"></h3>
                <div id="playerViewScore" style="font-size: 72px; text-align: center; margin: 30px 0;"></div>
                <p style="text-align: center; color: #6c757d;">Waiting for scorekeeper to update scores...</p>
            </div>

            <div id="playerViewScores" class="card">
                <h3 style="margin-top: 0;">All Players:</h3>
                <div id="allPlayersScores">
                    <!-- All players scores will be dynamically added here -->
                </div>
            </div>

            <div class="footer-actions">
                <button class="btn btn-danger" id="leaveGameBtn">🚪 Leave Game</button>
            </div>
        </div>

        <!-- Spectator View Page -->
        <div id="spectatorView" class="page">
            <div class="scorekeeper-header">
                <h2>👁️ Spectator View</h2>
                <p id="spectatorViewSessionInfo"></p>
            </div>

            <div id="spectatorViewScores" class="card">
                <h3 style="margin-top: 0;">Current Scores:</h3>
                <div id="spectatorAllPlayersScores">
                    <!-- All players scores will be dynamically added here -->
                </div>
            </div>

            <div class="footer-actions">
                <button class="btn btn-danger" id="spectatorLeaveGameBtn">🚪 Leave Game</button>
            </div>
        </div>

        <!-- Team Setup Page -->
        <div id="teamSetup" class="page">
            <div class="scorekeeper-header">
                <h2>👥 Team Setup</h2>
                <p id="teamSetupSessionInfo"></p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">Teams</h3>
                <div id="teamList" class="team-list">
                    <!-- Teams will be dynamically added here -->
                </div>

                <div class="team-actions">
                    <button class="btn btn-primary" id="createTeamBtn">➕ Create Team</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">Unassigned Players</h3>
                <div id="unassignedPlayers" class="unassigned-players">
                    <!-- Unassigned players will be dynamically added here -->
                </div>
            </div>

            <div class="footer-actions">
                <button class="btn btn-success" id="saveTeamsBtn">💾 Save Teams</button>
                <button class="btn btn-light" id="backToScorekeeperBtn">← Back to Scorekeeper</button>
            </div>
        </div>

        <!-- Modals -->
        <div id="editNameModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Player Name</h3>
                    <button class="modal-close" id="closeEditNameModal">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="editNameInput">
                    <input type="hidden" id="editNamePlayerId">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" id="cancelEditName">Cancel</button>
                    <button class="btn btn-primary" id="saveEditName">Save</button>
                </div>
            </div>
        </div>

        <div id="colorPickerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Choose Player Color</h3>
                    <button class="modal-close" id="closeColorPickerModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="color-picker" id="colorOptions">
                        <div class="color-option" style="background-color: #20c997;" data-color="#20c997"></div>
                        <div class="color-option" style="background-color: #fd7e14;" data-color="#fd7e14"></div>
                        <div class="color-option" style="background-color: #dc3545;" data-color="#dc3545"></div>
                        <div class="color-option" style="background-color: #6f42c1;" data-color="#6f42c1"></div>
                        <div class="color-option" style="background-color: #0dcaf0;" data-color="#0dcaf0"></div>
                        <div class="color-option" style="background-color: #198754;" data-color="#198754"></div>
                        <div class="color-option" style="background-color: #ffc107;" data-color="#ffc107"></div>
                        <div class="color-option" style="background-color: #0d6efd;" data-color="#0d6efd"></div>
                    </div>
                    <input type="hidden" id="colorPickerPlayerId">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" id="cancelColorPicker">Cancel</button>
                    <button class="btn btn-primary" id="saveColorPicker">Save</button>
                </div>
            </div>
        </div>

        <div id="customScoreModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Enter Custom Score</h3>
                    <button class="modal-close" id="closeCustomScoreModal">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control custom-score-input" id="customScoreInput" placeholder="Enter score change">
                    <input type="hidden" id="customScorePlayerId">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" id="cancelCustomScore">Cancel</button>
                    <button class="btn btn-primary" id="saveCustomScore">Apply</button>
                </div>
            </div>
        </div>

        <div id="createTeamModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Create New Team</h3>
                    <button class="modal-close" id="closeCreateTeamModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Team Name</label>
                        <input type="text" class="form-control" id="teamNameInput" placeholder="Enter team name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" id="cancelCreateTeam">Cancel</button>
                    <button class="btn btn-primary" id="saveCreateTeam">Create</button>
                </div>
            </div>
        </div>

        <div id="toastContainer" class="toast-container">
            <!-- Toasts will be dynamically added here -->
        </div>
    </div>

    <script>
        // GameScore Pro - Final Solution with URL Session Sharing
        console.log('GameScore Pro starting...');

        // Global variables
        let currentSession = null;
        let currentPlayerId = null;
        let currentPlayerName = "Guest";
        let currentPlayerTileColor = '#20c997';
        let selectedColor = '#20c997';
        let isDarkTheme = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            // Check for dark mode preference
            if (localStorage.getItem('darkTheme') === 'true') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeToggle').textContent = '☀️';
                isDarkTheme = true;
            }

            // Check for session in URL
            checkUrlForSession();
            
            // Bind event listeners
            bindEventListeners();
            
            console.log('App initialized successfully!');
        });

        // Function to show a specific page
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('active');
                console.log('Page shown successfully:', pageId);
            } else {
                console.error('Page not found:', pageId);
            }
        }

        // Function to show a message toast
        function showMessage(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '📣';
            if (type === 'success') icon = '✅';
            if (type === 'error') icon = '❌';
            if (type === 'warning') icon = '⚠️';
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Function to bind all event listeners
        function bindEventListeners() {
            console.log('Starting button binding...');
            
            // Landing page buttons
            const createButton = document.getElementById('createSessionCard');
            console.log('Create button element:', createButton);
            if (createButton) {
                createButton.addEventListener('click', function() {
                    console.log('Create button clicked, navigating to createSession');
                    showPage('createSession');
                });
                console.log('Create button bound');
            }
            
            const joinButton = document.getElementById('joinSessionCard');
            if (joinButton) {
                joinButton.addEventListener('click', function() {
                    showPage('joinSession');
                });
                console.log('Join button bound');
            }
            
            // Create session form
            const createForm = document.getElementById('createSessionForm');
            if (createForm) {
                createForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createSession();
                });
                console.log('Create form bound');
            }
            
            // Join session form
            const joinForm = document.getElementById('joinSessionForm');
            if (joinForm) {
                joinForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    joinSession();
                });
                console.log('Join form bound');
            }
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    document.body.classList.toggle('dark-theme');
                    isDarkTheme = document.body.classList.contains('dark-theme');
                    localStorage.setItem('darkTheme', isDarkTheme);
                    themeToggle.textContent = isDarkTheme ? '☀️' : '🌙';
                });
                console.log('Theme toggle bound');
            }
            
            // Back buttons
            document.getElementById('backToLandingBtn')?.addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('backToLandingFromJoinBtn')?.addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('backToHomeBtn')?.addEventListener('click', function() {
                showPage('landing');
            });
            
            document.getElementById('backToScorekeeperBtn')?.addEventListener('click', function() {
                showPage('scorekeeper');
            });
            
            // Player counter buttons
            const decreasePlayerBtn = document.getElementById('decreasePlayerBtn');
            if (decreasePlayerBtn) {
                decreasePlayerBtn.addEventListener('click', function() {
                    const playerCountInput = document.getElementById('playerCount');
                    let count = parseInt(playerCountInput.value);
                    if (count > 1) {
                        playerCountInput.value = count - 1;
                    }
                });
                console.log('Decrease player button bound');
            }
            
            const increasePlayerBtn = document.getElementById('increasePlayerBtn');
            if (increasePlayerBtn) {
                increasePlayerBtn.addEventListener('click', function() {
                    const playerCountInput = document.getElementById('playerCount');
                    let count = parseInt(playerCountInput.value);
                    playerCountInput.value = count + 1;
                });
                console.log('Increase player button bound');
            }
            
            // Session success page buttons
            document.getElementById('startScoringBtn')?.addEventListener('click', function() {
                console.log('Start scoring button clicked');
                console.log('Current session:', currentSession);
                console.log('updateScorekeeperInterface function:', updateScorekeeperInterface);
                showPage('scorekeeper');
                updateScorekeeperInterface();
            });
            
            document.getElementById('copyCodeBtn')?.addEventListener('click', function() {
                const sessionUrl = generateSessionUrl();
                navigator.clipboard.writeText(sessionUrl).then(function() {
                    showMessage('Session URL copied to clipboard!', 'success');
                }, function() {
                    showMessage('Failed to copy URL', 'error');
                });
            });
            
            document.getElementById('setupTeamsBtn')?.addEventListener('click', function() {
                showPage('teamSetup');
                updateTeamSetupInterface();
            });
            
            // Scorekeeper page buttons
            document.getElementById('shareCodeBtn')?.addEventListener('click', function() {
                const sessionUrl = generateSessionUrl();
                navigator.clipboard.writeText(sessionUrl).then(function() {
                    showMessage('Session URL copied to clipboard!', 'success');
                }, function() {
                    showMessage('Failed to copy URL', 'error');
                });
            });
            
            document.getElementById('viewReportBtn')?.addEventListener('click', function() {
                showMessage('Report feature coming soon!', 'info');
            });
            
            document.getElementById('resetScoresBtn')?.addEventListener('click', function() {
                if (confirm('Are you sure you want to reset all scores to the starting value?')) {
                    resetAllScores();
                }
            });
            
            document.getElementById('endGameBtn')?.addEventListener('click', function() {
                if (confirm('Are you sure you want to end this game session?')) {
                    endGame();
                }
            });
            
            // Player view page buttons
            document.getElementById('leaveGameBtn')?.addEventListener('click', function() {
                if (confirm('Are you sure you want to leave this game?')) {
                    leaveGame();
                }
            });
            
            // Spectator view page buttons
            document.getElementById('spectatorLeaveGameBtn')?.addEventListener('click', function() {
                if (confirm('Are you sure you want to leave this game?')) {
                    leaveGame();
                }
            });
            
            // Team setup page buttons
            document.getElementById('createTeamBtn')?.addEventListener('click', function() {
                showModal('createTeamModal');
            });
            
            document.getElementById('saveTeamsBtn')?.addEventListener('click', function() {
                saveTeams();
                showPage('scorekeeper');
                updateScorekeeperInterface();
                showMessage('Teams saved successfully!', 'success');
            });
            
            // Modal buttons
            document.getElementById('closeEditNameModal')?.addEventListener('click', function() {
                hideModal('editNameModal');
            });
            
            document.getElementById('cancelEditName')?.addEventListener('click', function() {
                hideModal('editNameModal');
            });
            
            document.getElementById('saveEditName')?.addEventListener('click', function() {
                const playerId = document.getElementById('editNamePlayerId').value;
                const newName = document.getElementById('editNameInput').value;
                updatePlayerName(playerId, newName);
                hideModal('editNameModal');
            });
            
            document.getElementById('closeColorPickerModal')?.addEventListener('click', function() {
                hideModal('colorPickerModal');
            });
            
            document.getElementById('cancelColorPicker')?.addEventListener('click', function() {
                hideModal('colorPickerModal');
            });
            
            document.getElementById('saveColorPicker')?.addEventListener('click', function() {
                const playerId = document.getElementById('colorPickerPlayerId').value;
                updatePlayerColor(playerId, selectedColor);
                hideModal('colorPickerModal');
            });
            
            // Color picker options
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.getAttribute('data-color');
                });
            });
            
            document.getElementById('closeCustomScoreModal')?.addEventListener('click', function() {
                hideModal('customScoreModal');
            });
            
            document.getElementById('cancelCustomScore')?.addEventListener('click', function() {
                hideModal('customScoreModal');
            });
            
            document.getElementById('saveCustomScore')?.addEventListener('click', function() {
                const playerId = document.getElementById('customScorePlayerId').value;
                const scoreChange = parseFloat(document.getElementById('customScoreInput').value);
                if (!isNaN(scoreChange)) {
                    updateScore(playerId, scoreChange);
                    hideModal('customScoreModal');
                } else {
                    showMessage('Please enter a valid number', 'error');
                }
            });
            
            document.getElementById('closeCreateTeamModal')?.addEventListener('click', function() {
                hideModal('createTeamModal');
            });
            
            document.getElementById('cancelCreateTeam')?.addEventListener('click', function() {
                hideModal('createTeamModal');
            });
            
            document.getElementById('saveCreateTeam')?.addEventListener('click', function() {
                const teamName = document.getElementById('teamNameInput').value;
                if (teamName.trim() !== '') {
                    createTeam(teamName);
                    hideModal('createTeamModal');
                    updateTeamSetupInterface();
                } else {
                    showMessage('Please enter a team name', 'error');
                }
            });
            
            // Export button
            document.getElementById('exportBtn')?.addEventListener('click', function() {
                exportSessionData();
            });
        }

        // Function to show a modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // Function to hide a modal
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Function to create a new session
        function createSession() {
            console.log('Creating session...');
            
            // Generate a random 6-character code
            const sessionCode = generateSessionCode();
            console.log('Generated session code:', sessionCode);
            
            // Get form values
            const sessionName = document.getElementById('sessionName').value || 'Game Session';
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const startingScore = parseFloat(document.getElementById('startingScore').value);
            const allowDecimals = document.getElementById('allowDecimals').checked;
            const targetScore = document.getElementById('targetScore').value ? parseFloat(document.getElementById('targetScore').value) : null;
            const playAfterTarget = document.getElementById('playAfterTarget').checked;
            
            // Create host player
            const hostPlayerId = 'player_' + Date.now();
            currentPlayerId = hostPlayerId;
            currentPlayerName = 'Host';
            
            // Create session object
            currentSession = {
                code: sessionCode,
                name: sessionName,
                playerCount: playerCount,
                startingScore: startingScore,
                allowDecimals: allowDecimals,
                targetScore: targetScore,
                playAfterTarget: playAfterTarget,
                createdAt: Date.now(),
                players: [
                    {
                        id: hostPlayerId,
                        name: 'Host',
                        score: startingScore,
                        color: currentPlayerTileColor,
                        isHost: true,
                        history: [
                            {
                                score: startingScore,
                                change: 0,
                                timestamp: Date.now()
                            }
                        ]
                    }
                ],
                teams: {},
                history: []
            };
            
            // Save session to localStorage
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update session success page
            document.getElementById('displaySessionCode').textContent = sessionCode;
            document.getElementById('displaySessionName').textContent = sessionName;
            document.getElementById('displayPlayerCount').textContent = playerCount;
            document.getElementById('displayStartingScore').textContent = startingScore;
            document.getElementById('displayTargetScore').textContent = targetScore !== null ? targetScore : 'None';
            document.getElementById('displaySessionCodeInSteps').textContent = sessionCode;
            
            // Show session success page
            showPage('sessionSuccess');
        }

        // Function to generate a random session code
        function generateSessionCode() {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed similar looking characters
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // Function to join an existing session
        function joinSession() {
            const sessionCode = document.getElementById('sessionCode').value.toUpperCase();
            const playerName = document.getElementById('playerName').value || 'Player';
            const joinAsSpectator = document.getElementById('joinAsSpectator').checked;
            
            console.log('Attempting to join session', sessionCode, 'as', playerName);
            
            // First try to get session from URL
            let sessionData = getSessionDataFromURL();
            
            if (sessionData && sessionData.code === sessionCode) {
                console.log('Session found in URL:', sessionData);
                currentSession = sessionData;
                
                if (joinAsSpectator) {
                    currentPlayerName = playerName;
                    showMessage(`Joined as spectator: ${playerName}`, 'success');
                    showPage('spectatorView');
                    updateSpectatorView();
                } else {
                    // Add the new player to the session
                    const playerId = 'player_' + Date.now();
                    currentPlayerId = playerId;
                    currentPlayerName = playerName;
                    
                    const newPlayer = {
                        id: playerId,
                        name: playerName,
                        score: currentSession.startingScore,
                        color: currentPlayerTileColor,
                        isHost: false,
                        history: [
                            {
                                score: currentSession.startingScore,
                                change: 0,
                                timestamp: Date.now()
                            }
                        ]
                    };
                    
                    currentSession.players.push(newPlayer);
                    saveSessionData();
                    updateURLWithSessionData();
                    
                    showMessage(`Joined as player: ${playerName}`, 'success');
                    showPage('playerView');
                    updatePlayerView();
                }
                return;
            }
            
            // If not found in URL, try localStorage
            const localSessions = getLocalSessions();
            const session = localSessions.find(s => s.code === sessionCode);
            
            if (session) {
                currentSession = session;
                
                if (joinAsSpectator) {
                    currentPlayerName = playerName;
                    showMessage(`Joined as spectator: ${playerName}`, 'success');
                    showPage('spectatorView');
                    updateSpectatorView();
                } else {
                    // Add the new player to the session
                    const playerId = 'player_' + Date.now();
                    currentPlayerId = playerId;
                    currentPlayerName = playerName;
                    
                    const newPlayer = {
                        id: playerId,
                        name: playerName,
                        score: currentSession.startingScore,
                        color: currentPlayerTileColor,
                        isHost: false,
                        history: [
                            {
                                score: currentSession.startingScore,
                                change: 0,
                                timestamp: Date.now()
                            }
                        ]
                    };
                    
                    currentSession.players.push(newPlayer);
                    saveSessionData();
                    updateURLWithSessionData();
                    
                    showMessage(`Joined as player: ${playerName}`, 'success');
                    showPage('playerView');
                    updatePlayerView();
                }
            } else {
                // Session not found
                const availableSessions = getLocalSessions().map(s => s.code).join(', ');
                const errorMessage = `Session "${sessionCode}" not found. ${availableSessions ? 'Available sessions: ' + availableSessions : 'No sessions found on this device.'}`;
                showMessage(errorMessage, 'error');
            }
        }

        // Function to update the scorekeeper interface
        function updateScorekeeperInterface() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Update header info
            const sessionInfo = document.getElementById('sessionInfo');
            if (sessionInfo) {
                const targetScoreText = currentSession.targetScore ? currentSession.targetScore : 'None';
                sessionInfo.textContent = `Session: ${currentSession.code}|${currentSession.name} | Target Score: ${targetScoreText} | Managing ${currentSession.players.length} players`;
            }
            
            // Clear existing player grid
            const playerGrid = document.getElementById('playerGrid');
            if (playerGrid) {
                playerGrid.innerHTML = '';
                
                // Add player cards
                currentSession.players.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'player-card';
                    playerCard.style.borderTopColor = player.color;
                    
                    // Add badges if applicable
                    if (player.isHost) {
                        const hostBadge = document.createElement('div');
                        hostBadge.className = 'player-badge host-badge';
                        hostBadge.textContent = 'Host';
                        playerCard.appendChild(hostBadge);
                    }
                    
                    if (player.id === currentPlayerId) {
                        const youBadge = document.createElement('div');
                        youBadge.className = 'player-badge you-badge';
                        youBadge.textContent = 'You';
                        playerCard.appendChild(youBadge);
                    }
                    
                    // Player name (editable)
                    const playerName = document.createElement('h3');
                    playerName.className = 'player-name';
                    playerName.textContent = player.name;
                    playerName.addEventListener('click', function() {
                        if (player.isHost || player.id === currentPlayerId) {
                            document.getElementById('editNameInput').value = player.name;
                            document.getElementById('editNamePlayerId').value = player.id;
                            showModal('editNameModal');
                        } else {
                            showMessage('Only the host can edit other players\' names', 'info');
                        }
                    });
                    playerCard.appendChild(playerName);
                    
                    // Player score
                    const playerScore = document.createElement('div');
                    playerScore.className = 'player-score';
                    playerScore.textContent = player.score;
                    playerCard.appendChild(playerScore);
                    
                    // Score buttons
                    const scoreButtons = document.createElement('div');
                    scoreButtons.className = 'score-buttons';
                    
                    // Minus buttons
                    const minus10Btn = document.createElement('button');
                    minus10Btn.className = 'score-btn minus';
                    minus10Btn.textContent = '-10';
                    minus10Btn.addEventListener('click', function() {
                        updateScore(player.id, -10);
                    });
                    scoreButtons.appendChild(minus10Btn);
                    
                    const minus5Btn = document.createElement('button');
                    minus5Btn.className = 'score-btn minus';
                    minus5Btn.textContent = '-5';
                    minus5Btn.addEventListener('click', function() {
                        updateScore(player.id, -5);
                    });
                    scoreButtons.appendChild(minus5Btn);
                    
                    const minus1Btn = document.createElement('button');
                    minus1Btn.className = 'score-btn minus';
                    minus1Btn.textContent = '-1';
                    minus1Btn.addEventListener('click', function() {
                        updateScore(player.id, -1);
                    });
                    scoreButtons.appendChild(minus1Btn);
                    
                    // Custom score button
                    const customBtn = document.createElement('button');
                    customBtn.className = 'score-btn custom';
                    customBtn.textContent = '1';
                    customBtn.addEventListener('click', function() {
                        document.getElementById('customScoreInput').value = '';
                        document.getElementById('customScorePlayerId').value = player.id;
                        showModal('customScoreModal');
                    });
                    scoreButtons.appendChild(customBtn);
                    
                    // Plus buttons
                    const plus1Btn = document.createElement('button');
                    plus1Btn.className = 'score-btn plus';
                    plus1Btn.textContent = '+1';
                    plus1Btn.addEventListener('click', function() {
                        updateScore(player.id, 1);
                    });
                    scoreButtons.appendChild(plus1Btn);
                    
                    const plus5Btn = document.createElement('button');
                    plus5Btn.className = 'score-btn plus';
                    plus5Btn.textContent = '+5';
                    plus5Btn.addEventListener('click', function() {
                        updateScore(player.id, 5);
                    });
                    scoreButtons.appendChild(plus5Btn);
                    
                    const plus10Btn = document.createElement('button');
                    plus10Btn.className = 'score-btn plus';
                    plus10Btn.textContent = '+10';
                    plus10Btn.addEventListener('click', function() {
                        updateScore(player.id, 10);
                    });
                    scoreButtons.appendChild(plus10Btn);
                    
                    playerCard.appendChild(scoreButtons);
                    
                    // Player actions
                    const playerActions = document.createElement('div');
                    playerActions.className = 'player-actions';
                    
                    const resetBtn = document.createElement('button');
                    resetBtn.className = 'btn btn-light';
                    resetBtn.innerHTML = '🔄 Reset';
                    resetBtn.addEventListener('click', function() {
                        resetPlayerScore(player.id);
                    });
                    playerActions.appendChild(resetBtn);
                    
                    const colorBtn = document.createElement('button');
                    colorBtn.className = 'btn btn-light';
                    colorBtn.innerHTML = '🎨 Color';
                    colorBtn.addEventListener('click', function() {
                        document.getElementById('colorPickerPlayerId').value = player.id;
                        document.querySelectorAll('.color-option').forEach(option => {
                            if (option.getAttribute('data-color') === player.color) {
                                option.classList.add('selected');
                                selectedColor = player.color;
                            } else {
                                option.classList.remove('selected');
                            }
                        });
                        showModal('colorPickerModal');
                    });
                    playerActions.appendChild(colorBtn);
                    
                    playerCard.appendChild(playerActions);
                    
                    playerGrid.appendChild(playerCard);
                });
            }
        }

        // Function to update the player view
        function updatePlayerView() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find current player
            const player = currentSession.players.find(p => p.id === currentPlayerId);
            if (!player) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Update header info
            const playerViewSessionInfo = document.getElementById('playerViewSessionInfo');
            if (playerViewSessionInfo) {
                const targetScoreText = currentSession.targetScore ? currentSession.targetScore : 'None';
                playerViewSessionInfo.textContent = `Session: ${currentSession.code}|${currentSession.name} | Target Score: ${targetScoreText}`;
            }
            
            // Update player name and score
            document.getElementById('playerViewName').textContent = player.name;
            document.getElementById('playerViewScore').textContent = player.score;
            
            // Update all players scores
            const allPlayersScores = document.getElementById('allPlayersScores');
            if (allPlayersScores) {
                allPlayersScores.innerHTML = '';
                
                currentSession.players.forEach(p => {
                    const playerItem = document.createElement('div');
                    playerItem.style.display = 'flex';
                    playerItem.style.justifyContent = 'space-between';
                    playerItem.style.marginBottom = '10px';
                    playerItem.style.padding = '10px';
                    playerItem.style.borderLeft = `5px solid ${p.color}`;
                    playerItem.style.backgroundColor = isDarkTheme ? '#2c3034' : '#f8f9fa';
                    playerItem.style.borderRadius = '5px';
                    
                    const playerName = document.createElement('div');
                    playerName.textContent = p.name;
                    if (p.isHost) {
                        playerName.textContent += ' (Host)';
                    }
                    if (p.id === currentPlayerId) {
                        playerName.textContent += ' (You)';
                    }
                    playerItem.appendChild(playerName);
                    
                    const playerScore = document.createElement('div');
                    playerScore.textContent = p.score;
                    playerScore.style.fontWeight = 'bold';
                    playerItem.appendChild(playerScore);
                    
                    allPlayersScores.appendChild(playerItem);
                });
            }
        }

        // Function to update the spectator view
        function updateSpectatorView() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Update header info
            const spectatorViewSessionInfo = document.getElementById('spectatorViewSessionInfo');
            if (spectatorViewSessionInfo) {
                const targetScoreText = currentSession.targetScore ? currentSession.targetScore : 'None';
                spectatorViewSessionInfo.textContent = `Session: ${currentSession.code}|${currentSession.name} | Target Score: ${targetScoreText}`;
            }
            
            // Update all players scores
            const spectatorAllPlayersScores = document.getElementById('spectatorAllPlayersScores');
            if (spectatorAllPlayersScores) {
                spectatorAllPlayersScores.innerHTML = '';
                
                currentSession.players.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.style.display = 'flex';
                    playerItem.style.justifyContent = 'space-between';
                    playerItem.style.marginBottom = '10px';
                    playerItem.style.padding = '10px';
                    playerItem.style.borderLeft = `5px solid ${player.color}`;
                    playerItem.style.backgroundColor = isDarkTheme ? '#2c3034' : '#f8f9fa';
                    playerItem.style.borderRadius = '5px';
                    
                    const playerName = document.createElement('div');
                    playerName.textContent = player.name;
                    if (player.isHost) {
                        playerName.textContent += ' (Host)';
                    }
                    playerItem.appendChild(playerName);
                    
                    const playerScore = document.createElement('div');
                    playerScore.textContent = player.score;
                    playerScore.style.fontWeight = 'bold';
                    playerItem.appendChild(playerScore);
                    
                    spectatorAllPlayersScores.appendChild(playerItem);
                });
            }
        }

        // Function to update a player's score
        function updateScore(playerId, change) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find the player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Update the score
            const player = currentSession.players[playerIndex];
            const oldScore = player.score;
            let newScore;
            
            if (currentSession.allowDecimals) {
                newScore = parseFloat((oldScore + change).toFixed(2));
            } else {
                newScore = Math.round(oldScore + change);
            }
            
            player.score = newScore;
            
            // Add to history
            player.history.push({
                score: newScore,
                change: change,
                timestamp: Date.now()
            });
            
            // Add to session history
            currentSession.history.push({
                playerId: playerId,
                playerName: player.name,
                oldScore: oldScore,
                newScore: newScore,
                change: change,
                timestamp: Date.now()
            });
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update interfaces
            updateScorekeeperInterface();
            updatePlayerView();
            updateSpectatorView();
            
            console.log(`Player ${player.name} score changed by ${change} to ${newScore}`);
            
            // Check for target score
            if (currentSession.targetScore !== null && newScore >= currentSession.targetScore && !currentSession.playAfterTarget) {
                showMessage(`${player.name} has reached the target score!`, 'success');
            }
        }

        // Function to reset a player's score
        function resetPlayerScore(playerId) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find the player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Reset the score
            const player = currentSession.players[playerIndex];
            const oldScore = player.score;
            const newScore = currentSession.startingScore;
            
            player.score = newScore;
            
            // Add to history
            player.history.push({
                score: newScore,
                change: newScore - oldScore,
                timestamp: Date.now()
            });
            
            // Add to session history
            currentSession.history.push({
                playerId: playerId,
                playerName: player.name,
                oldScore: oldScore,
                newScore: newScore,
                change: newScore - oldScore,
                timestamp: Date.now()
            });
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update interfaces
            updateScorekeeperInterface();
            updatePlayerView();
            updateSpectatorView();
            
            showMessage(`${player.name}'s score has been reset to ${newScore}`, 'info');
        }

        // Function to reset all scores
        function resetAllScores() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Reset all player scores
            currentSession.players.forEach(player => {
                const oldScore = player.score;
                const newScore = currentSession.startingScore;
                
                player.score = newScore;
                
                // Add to history
                player.history.push({
                    score: newScore,
                    change: newScore - oldScore,
                    timestamp: Date.now()
                });
                
                // Add to session history
                currentSession.history.push({
                    playerId: player.id,
                    playerName: player.name,
                    oldScore: oldScore,
                    newScore: newScore,
                    change: newScore - oldScore,
                    timestamp: Date.now()
                });
            });
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update interfaces
            updateScorekeeperInterface();
            updatePlayerView();
            updateSpectatorView();
            
            showMessage('All scores have been reset', 'info');
        }

        // Function to update a player's name
        function updatePlayerName(playerId, newName) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find the player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Update the name
            const player = currentSession.players[playerIndex];
            const oldName = player.name;
            player.name = newName;
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update interfaces
            updateScorekeeperInterface();
            updatePlayerView();
            updateSpectatorView();
            
            showMessage(`Player name changed from ${oldName} to ${newName}`, 'success');
        }

        // Function to update a player's color
        function updatePlayerColor(playerId, newColor) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Find the player
            const playerIndex = currentSession.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                showMessage('Player not found', 'error');
                return;
            }
            
            // Update the color
            const player = currentSession.players[playerIndex];
            player.color = newColor;
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update interfaces
            updateScorekeeperInterface();
            updatePlayerView();
            updateSpectatorView();
            
            showMessage(`${player.name}'s color has been updated`, 'success');
        }

        // Function to end the game
        function endGame() {
            // Clear session data
            currentSession = null;
            currentPlayerId = null;
            currentPlayerName = "Guest";
            
            // Clear URL parameters
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Show landing page
            showPage('landing');
            
            showMessage('Game ended', 'info');
        }

        // Function to leave the game
        function leaveGame() {
            // Clear session data
            currentSession = null;
            currentPlayerId = null;
            currentPlayerName = "Guest";
            
            // Clear URL parameters
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Show landing page
            showPage('landing');
            
            showMessage('You have left the game', 'info');
        }

        // Function to update the team setup interface
        function updateTeamSetupInterface() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Update header info
            const teamSetupSessionInfo = document.getElementById('teamSetupSessionInfo');
            if (teamSetupSessionInfo) {
                teamSetupSessionInfo.textContent = `Session: ${currentSession.code}|${currentSession.name}`;
            }
            
            // Update team list
            const teamList = document.getElementById('teamList');
            if (teamList) {
                teamList.innerHTML = '';
                
                // Add team cards
                Object.entries(currentSession.teams).forEach(([teamId, team]) => {
                    const teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    teamCard.style.borderLeftColor = team.color;
                    
                    const teamHeader = document.createElement('div');
                    teamHeader.className = 'team-header';
                    
                    const teamName = document.createElement('h4');
                    teamName.className = 'team-name';
                    teamName.textContent = team.name;
                    teamHeader.appendChild(teamName);
                    
                    const teamScore = document.createElement('div');
                    teamScore.className = 'team-score';
                    
                    // Calculate team score
                    let totalScore = 0;
                    team.members.forEach(memberId => {
                        const player = currentSession.players.find(p => p.id === memberId);
                        if (player) {
                            totalScore += player.score;
                        }
                    });
                    
                    teamScore.textContent = totalScore;
                    teamHeader.appendChild(teamScore);
                    
                    teamCard.appendChild(teamHeader);
                    
                    const teamMembers = document.createElement('div');
                    teamMembers.className = 'team-members';
                    
                    team.members.forEach(memberId => {
                        const player = currentSession.players.find(p => p.id === memberId);
                        if (player) {
                            const teamMember = document.createElement('div');
                            teamMember.className = 'team-member';
                            teamMember.textContent = player.name;
                            teamMember.style.backgroundColor = player.color;
                            teamMember.style.color = getContrastColor(player.color);
                            
                            // Add remove button
                            const removeBtn = document.createElement('span');
                            removeBtn.textContent = ' ✕';
                            removeBtn.style.cursor = 'pointer';
                            removeBtn.style.marginLeft = '5px';
                            removeBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                removePlayerFromTeam(teamId, memberId);
                            });
                            
                            teamMember.appendChild(removeBtn);
                            teamMembers.appendChild(teamMember);
                        }
                    });
                    
                    teamCard.appendChild(teamMembers);
                    
                    // Add delete team button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.textContent = 'Delete Team';
                    deleteBtn.style.marginTop = '10px';
                    deleteBtn.addEventListener('click', function() {
                        deleteTeam(teamId);
                    });
                    
                    teamCard.appendChild(deleteBtn);
                    
                    teamList.appendChild(teamCard);
                });
                
                if (Object.keys(currentSession.teams).length === 0) {
                    const noTeamsMessage = document.createElement('p');
                    noTeamsMessage.textContent = 'No teams created yet. Click "Create Team" to add a team.';
                    teamList.appendChild(noTeamsMessage);
                }
            }
            
            // Update unassigned players
            const unassignedPlayers = document.getElementById('unassignedPlayers');
            if (unassignedPlayers) {
                unassignedPlayers.innerHTML = '';
                
                // Get all assigned player IDs
                const assignedPlayerIds = new Set();
                Object.values(currentSession.teams).forEach(team => {
                    team.members.forEach(memberId => {
                        assignedPlayerIds.add(memberId);
                    });
                });
                
                // Add unassigned players
                const unassignedPlayersList = currentSession.players.filter(player => !assignedPlayerIds.has(player.id));
                
                unassignedPlayersList.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    
                    const playerName = document.createElement('div');
                    playerName.className = 'player-item-name';
                    playerName.textContent = player.name;
                    playerItem.appendChild(playerName);
                    
                    const teamSelect = document.createElement('select');
                    teamSelect.className = 'form-control';
                    teamSelect.style.width = 'auto';
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Assign to team...';
                    teamSelect.appendChild(defaultOption);
                    
                    Object.entries(currentSession.teams).forEach(([teamId, team]) => {
                        const option = document.createElement('option');
                        option.value = teamId;
                        option.textContent = team.name;
                        teamSelect.appendChild(option);
                    });
                    
                    teamSelect.addEventListener('change', function() {
                        if (this.value) {
                            assignPlayerToTeam(this.value, player.id);
                        }
                    });
                    
                    playerItem.appendChild(teamSelect);
                    unassignedPlayers.appendChild(playerItem);
                });
                
                if (unassignedPlayersList.length === 0) {
                    const noPlayersMessage = document.createElement('p');
                    noPlayersMessage.textContent = 'All players are assigned to teams.';
                    unassignedPlayers.appendChild(noPlayersMessage);
                }
            }
        }

        // Function to create a team
        function createTeam(teamName) {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            const teamId = 'team_' + Date.now();
            const teamColor = getRandomColor();
            
            currentSession.teams[teamId] = {
                id: teamId,
                name: teamName,
                color: teamColor,
                members: []
            };
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            showMessage(`Team "${teamName}" created`, 'success');
        }

        // Function to delete a team
        function deleteTeam(teamId) {
            if (!currentSession || !currentSession.teams[teamId]) {
                showMessage('Team not found', 'error');
                return;
            }
            
            delete currentSession.teams[teamId];
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update team setup interface
            updateTeamSetupInterface();
            
            showMessage('Team deleted', 'success');
        }

        // Function to assign a player to a team
        function assignPlayerToTeam(teamId, playerId) {
            if (!currentSession || !currentSession.teams[teamId]) {
                showMessage('Team not found', 'error');
                return;
            }
            
            // Remove player from any existing teams
            Object.values(currentSession.teams).forEach(team => {
                const memberIndex = team.members.indexOf(playerId);
                if (memberIndex !== -1) {
                    team.members.splice(memberIndex, 1);
                }
            });
            
            // Add player to the team
            currentSession.teams[teamId].members.push(playerId);
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
            
            // Update team setup interface
            updateTeamSetupInterface();
            
            const player = currentSession.players.find(p => p.id === playerId);
            const team = currentSession.teams[teamId];
            
            showMessage(`${player ? player.name : 'Player'} assigned to team "${team.name}"`, 'success');
        }

        // Function to remove a player from a team
        function removePlayerFromTeam(teamId, playerId) {
            if (!currentSession || !currentSession.teams[teamId]) {
                showMessage('Team not found', 'error');
                return;
            }
            
            const team = currentSession.teams[teamId];
            const memberIndex = team.members.indexOf(playerId);
            
            if (memberIndex !== -1) {
                team.members.splice(memberIndex, 1);
                
                // Save session data
                saveSessionData();
                
                // Update URL with session data
                updateURLWithSessionData();
                
                // Update team setup interface
                updateTeamSetupInterface();
                
                const player = currentSession.players.find(p => p.id === playerId);
                
                showMessage(`${player ? player.name : 'Player'} removed from team "${team.name}"`, 'success');
            }
        }

        // Function to save teams
        function saveTeams() {
            if (!currentSession) {
                showMessage('No active session', 'error');
                return;
            }
            
            // Save session data
            saveSessionData();
            
            // Update URL with session data
            updateURLWithSessionData();
        }

        // Function to export session data
        function exportSessionData() {
            if (!currentSession) {
                showMessage('No active session available to export', 'info');
                return;
            }
            
            // Create a JSON blob
            const sessionData = JSON.stringify(currentSession, null, 2);
            const blob = new Blob([sessionData], { type: 'application/json' });
            
            // Create a download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gamescore_${currentSession.code}_${new Date().toISOString().split('T')[0]}.json`;
            
            // Trigger download
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showMessage('Session data exported successfully', 'success');
        }

        // Function to get a random color
        function getRandomColor() {
            const colors = [
                '#20c997', '#fd7e14', '#dc3545', '#6f42c1',
                '#0dcaf0', '#198754', '#ffc107', '#0d6efd'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Function to get contrast color (black or white) based on background color
        function getContrastColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black for bright colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }

        // Function to save session data to localStorage
        function saveSessionData() {
            if (!currentSession) return;
            
            try {
                // Save to localStorage
                localStorage.setItem(`gameScore_session_${currentSession.code}`, JSON.stringify(currentSession));
                console.log('Session data saved to localStorage');
                
                // Update URL with session data
                updateURLWithSessionData();
            } catch (error) {
                console.error('Error saving session data:', error);
                showMessage('Error saving session data', 'error');
            }
        }

        // Function to get local sessions from localStorage
        function getLocalSessions() {
            const sessions = [];
            
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('gameScore_session_')) {
                        const sessionData = JSON.parse(localStorage.getItem(key));
                        sessions.push(sessionData);
                    }
                }
            } catch (error) {
                console.error('Error getting local sessions:', error);
            }
            
            return sessions;
        }

        // Function to update URL with session data
        function updateURLWithSessionData() {
            if (!currentSession) return;
            
            try {
                // Encode session data
                const sessionData = JSON.stringify(currentSession);
                const encodedData = btoa(encodeURIComponent(sessionData));
                
                // Update URL
                const url = new URL(window.location.href);
                url.searchParams.set('session', currentSession.code);
                url.searchParams.set('data', encodedData);
                
                window.history.replaceState({}, document.title, url.toString());
                console.log('URL updated with session data');
            } catch (error) {
                console.error('Error updating URL with session data:', error);
            }
        }

        // Function to get session data from URL
        function getSessionDataFromURL() {
            try {
                const url = new URL(window.location.href);
                const encodedData = url.searchParams.get('data');
                
                if (encodedData) {
                    const sessionData = JSON.parse(decodeURIComponent(atob(encodedData)));
                    console.log('Session data found in URL');
                    return sessionData;
                }
            } catch (error) {
                console.error('Error getting session data from URL:', error);
            }
            
            return null;
        }

        // Function to generate a session URL
        function generateSessionUrl() {
            if (!currentSession) return window.location.href;
            
            try {
                // Encode session data
                const sessionData = JSON.stringify(currentSession);
                const encodedData = btoa(encodeURIComponent(sessionData));
                
                // Create URL
                const url = new URL(window.location.href);
                url.searchParams.set('session', currentSession.code);
                url.searchParams.set('data', encodedData);
                
                return url.toString();
            } catch (error) {
                console.error('Error generating session URL:', error);
                return window.location.href;
            }
        }

        // Function to check URL for session data
        function checkUrlForSession() {
            try {
                const url = new URL(window.location.href);
                const sessionCode = url.searchParams.get('session');
                const encodedData = url.searchParams.get('data');
                
                if (sessionCode && encodedData) {
                    console.log('Session data found in URL, auto-filling join form');
                    
                    // Auto-fill join form
                    const sessionCodeInput = document.getElementById('sessionCode');
                    if (sessionCodeInput) {
                        sessionCodeInput.value = sessionCode;
                    }
                    
                    // Show join page
                    showPage('joinSession');
                }
            } catch (error) {
                console.error('Error checking URL for session:', error);
            }
        }

        console.log('GameScore Pro script loaded successfully!');
    </script>
</body>
</html>

